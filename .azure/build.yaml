name: 14.0.0-$(Rev:r)
pr: none
trigger: none

pool:
  vmImage: ubuntu-20.04

steps:
- checkout: self
  fetchDepth: 0

- task: NodeAndNpmTool@1
  inputs:
    versionSpec: 12.x
    
- script: |
    npm install -g npm@6.10.2
    npm install -g yarn@1.17.3
  displayName: npm install
- script: |
    mv package.json package.orig
    sed 's/0.0.0-semantically-released/$(Build.BuildNumber)/g' package.orig > package.json
    cat package.json |grep \"version\"
  displayName: Set version
- script: |
    yarn install --non-interactive --frozen-lockfile --cache-folder ~/.cache/yarn
  displayName: yarn install
- script: |
    yarn clean
  displayName: yarn clean
- script: |
    yarn build:i18n
  displayName: yarn build:i18n
- script: |
    yarn build:ci:es
  displayName: yarn build:ci:es
- script: |
    yarn build:ci:dist
  displayName: yarn build:ci:dist
- script: |
    yarn test
  displayName: yarn test

- publish: $(System.DefaultWorkingDirectory)
  name: source
  artifact: src

- task: Npm@1
  inputs:
    command: 'publish'
    publishRegistry: 'useFeed'
    publishFeed: '80bd0842-15be-4bac-8442-82eada5ce15f/4424f450-4ea4-4d30-ab33-6a067ed3327c'

# - task: PublishTestResults@2
#   inputs:
#       testResultsFormat: 'JUnit'
#       testResultsFiles: 'junit.xml'

# - task: PublishCodeCoverageResults@1
#   inputs:
#       codeCoverageTool: 'Cobertura'
#       summaryFileLocation: 'coverage/cobertura-coverage.xml'
